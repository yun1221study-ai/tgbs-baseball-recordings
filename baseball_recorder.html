<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>棒球紀錄系統 - 完整可新增比賽</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
  label { display: block; margin-top: 10px; }
  input, select, button, textarea { padding: 6px; font-size: 1rem; margin-top: 4px; }
  button { cursor: pointer; }
  .flex { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-top: 10px; }
  .small-input { width: 70px; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  table, th, td { border: 1px solid #ccc; padding: 8px; }
  th { background: #eee; }
  #eventList { max-height: 300px; overflow-y: auto; margin-top: 12px; border: 1px solid #ccc; padding: 10px; }
  #eventList li { margin-bottom: 6px; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>棒球紀錄系統（可新增比賽 + 紀錄事件）</h1>

<section>
  <label>新增比賽ID（請輸入唯一ID，例如：2025-08-08_TP_vs_KH）：<br/>
    <input type="text" id="inputGameId" placeholder="比賽ID" />
  </label>
  <label>隊伍1名稱：<br/>
    <input type="text" id="team1Name" placeholder="隊伍1" />
  </label>
  <label>隊伍2名稱：<br/>
    <input type="text" id="team2Name" placeholder="隊伍2" />
  </label>
  <button id="btnAddGame">新增比賽</button>
</section>

<section style="margin-top:20px;">
  <label>選擇比賽：
    <select id="selectGame">
      <option value="">請先新增比賽</option>
    </select>
  </label>
  <label>選擇局數：
    <select id="selectInning">
      <option value="1">第1局</option>
      <option value="2">第2局</option>
      <option value="3">第3局</option>
      <option value="4">第4局</option>
      <option value="5">第5局</option>
      <option value="6">第6局</option>
      <option value="7">第7局</option>
      <option value="8">第8局</option>
      <option value="9">第9局</option>
    </select>
  </label>
</section>

<section style="margin-top:20px; border-top: 2px solid #333; padding-top: 16px;">
  <h2>新增事件（每球紀錄）</h2>
  <div class="flex">
    <label>球數：
      <input type="number" id="pitchCountInput" class="small-input" min="1" value="1" />
    </label>
    <label>隊伍：
      <select id="teamSelect"><option value="">請先選擇比賽</option></select>
    </label>
    <label>打者：
      <input type="text" id="batterInput" placeholder="姓名或背號" />
    </label>
  </div>
  <div class="flex" style="margin-top:8px;">
    <label>投球結果：
      <select id="pitchResultSelect">
        <option value="S">好球 (S)</option>
        <option value="B">壞球 (B)</option>
        <option value="F">界外球 (F)</option>
        <option value="X">其他 (X)</option>
      </select>
    </label>
    <label>打擊結果：
      <select id="battingResultSelect">
        <option value="">無</option>
        <option value="single">一壘安打</option>
        <option value="double">二壘安打</option>
        <option value="triple">三壘安打</option>
        <option value="homeRun">本壘打</option>
        <option value="walk">保送</option>
        <option value="hitByPitch">觸身球</option>
        <option value="strikeOut">三振</option>
        <option value="groundOut">滾地出局</option>
        <option value="flyOut">飛球出局</option>
        <option value="sacFly">高飛犧牲打</option>
        <option value="sacBunt">犧牲觸擊</option>
        <option value="error">失誤上壘</option>
        <option value="fielderChoice">野手選擇</option>
      </select>
    </label>
    <label>出局原因：
      <select id="outReasonSelect">
        <option value="">無</option>
        <option value="strikeOut">三振</option>
        <option value="groundOut">滾地出局</option>
        <option value="flyOut">飛球出局</option>
        <option value="forceOut">封殺出局</option>
        <option value="doublePlay">雙殺</option>
        <option value="pickOff">牽制出局</option>
        <option value="otherOut">其他出局</option>
      </select>
    </label>
  </div>

  <div class="flex" style="margin-top:8px;">
    <label>盜壘起點：
      <select id="stealStartSelect">
        <option value="">無</option>
        <option value="1B">一壘</option>
        <option value="2B">二壘</option>
        <option value="3B">三壘</option>
      </select>
    </label>
    <label>盜壘終點：
      <select id="stealEndSelect">
        <option value="">無</option>
        <option value="2B">二壘</option>
        <option value="3B">三壘</option>
        <option value="HR">本壘</option>
      </select>
    </label>
    <label>盜壘結果：
      <select id="stealResultSelect">
        <option value="">無</option>
        <option value="SB">成功盜壘</option>
        <option value="CS">盜壘失敗</option>
      </select>
    </label>
  </div>

  <div class="flex" style="margin-top:8px;">
    <label><input type="checkbox" id="base1" /> 一壘有人</label>
    <label><input type="checkbox" id="base2" /> 二壘有人</label>
    <label><input type="checkbox" id="base3" /> 三壘有人</label>
  </div>

  <div class="flex" style="margin-top:8px;">
    <label>打點 (RBI)：<input type="number" id="rbiInput" class="small-input" min="0" value="0" /></label>
    <label>得分：<input type="number" id="runsInput" class="small-input" min="0" value="0" /></label>
  </div>

  <label style="margin-top:8px;">
    備註：
    <textarea id="remarkInput" placeholder="備註..." rows="3"></textarea>
  </label>

  <button id="btnAddEvent" style="margin-top: 12px;">新增事件</button>
</section>

<section style="margin-top: 20px; border-top: 2px solid #333; padding-top: 16px;">
  <h2>比分表</h2>
  <table>
    <thead>
      <tr>
        <th>局數</th>
        <th id="team1Header">隊伍1</th>
        <th id="team2Header">隊伍2</th>
      </tr>
    </thead>
    <tbody id="scoreTableBody">
      <tr><td colspan="3">請先選擇比賽</td></tr>
    </tbody>
  </table>
</section>

<section style="margin-top: 20px; border-top: 2px solid #333; padding-top: 16px;">
  <h2>事件列表</h2>
  <ul id="eventList">
    <li>請先選擇比賽</li>
  </ul>
</section>

<script>
  // 預設空物件儲存所有比賽資料
  let games = JSON.parse(localStorage.getItem('bbGames') || '{}');
  let currentGameId = '';
  let currentInning = 1;

  // 事件名稱對應中文
  const battingResultNames = {
    single: '一壘安打',
    double: '二壘安打',
    triple: '三壘安打',
    homeRun: '本壘打',
    walk: '保送',
    hitByPitch: '觸身球',
    strikeOut: '三振',
    groundOut: '滾地出局',
    flyOut: '飛球出局',
    sacFly: '高飛犧牲打',
    sacBunt: '犧牲觸擊',
    error: '失誤上壘',
    fielderChoice: '野手選擇'
  };

  const outReasonNames = {
    strikeOut: '三振',
    groundOut: '滾地出局',
    flyOut: '飛球出局',
    forceOut: '封殺出局',
    doublePlay: '雙殺',
    pickOff: '牽制出局',
    otherOut: '其他出局'
  };

  const pitchResultNames = {
    S: '好球',
    B: '壞球',
    F: '界外球',
    X: '其他'
  };

  // DOM 元素
  const inputGameId = document.getElementById('inputGameId');
  const team1NameInput = document.getElementById('team1Name');
  const team2NameInput = document.getElementById('team2Name');
  const btnAddGame = document.getElementById('btnAddGame');
  const selectGame = document.getElementById('selectGame');
  const selectInning = document.getElementById('selectInning');
  const teamSelect = document.getElementById('teamSelect');
  const pitchCountInput = document.getElementById('pitchCountInput');
  const batterInput = document.getElementById('batterInput');
  const pitchResultSelect = document.getElementById('pitchResultSelect');
  const battingResultSelect = document.getElementById('battingResultSelect');
  const outReasonSelect = document.getElementById('outReasonSelect');
  const stealStartSelect = document.getElementById('stealStartSelect');
  const stealEndSelect = document.getElementById('stealEndSelect');
  const stealResultSelect = document.getElementById('stealResultSelect');
  const base1 = document.getElementById('base1');
  const base2 = document.getElementById('base2');
  const base3 = document.getElementById('base3');
  const rbiInput = document.getElementById('rbiInput');
  const runsInput = document.getElementById('runsInput');
  const remarkInput = document.getElementById('remarkInput');
  const scoreTableBody = document.getElementById('scoreTableBody');
  const team1Header = document.getElementById('team1Header');
  const team2Header = document.getElementById('team2Header');
  const eventList = document.getElementById('eventList');

  // 新增比賽
  btnAddGame.addEventListener('click', () => {
    const gameId = inputGameId.value.trim();
    const t1 = team1NameInput.value.trim();
    const t2 = team2NameInput.value.trim();

    if (!gameId || !t1 || !t2) {
      alert('請輸入完整的比賽ID與隊伍名稱');
      return;
    }
    if (games[gameId]) {
      alert('此比賽ID已存在，請換一個');
      return;
    }

    games[gameId] = {
      team1: t1,
      team2: t2,
      innings: {}, // 局資料
      events: []  // 全場事件陣列
    };

    saveGames();
    updateGameOptions();
    selectGame.value = gameId;
    currentGameId = gameId;
    currentInning = 1;
    updateTeamsSelect();
    updateScoreTable();
    updateEventList();
    alert('比賽新增成功！');
  });

  // 儲存至 localStorage
  function saveGames() {
    localStorage.setItem('bbGames', JSON.stringify(games));
  }

  // 更新選擇比賽下拉選單
  function updateGameOptions() {
    const keys = Object.keys(games);
    selectGame.innerHTML = '<option value="" disabled>請選擇比賽</option>';
    keys.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = k + ' (' + games[k].team1 + ' vs ' + games[k].team2 + ')';
      selectGame.appendChild(opt);
    });
  }

  // 選擇比賽時更新相關資料
  selectGame.addEventListener('change', () => {
    currentGameId = selectGame.value;
    currentInning = Number(selectInning.value);
    updateTeamsSelect();
    updateScoreTable();
    updateEventList();
  });

  // 選擇局數時更新
  selectInning.addEventListener('change', () => {
    currentInning = Number(selectInning.value);
  });

  // 更新隊伍下拉選單(打者所屬隊伍)
  function updateTeamsSelect() {
    if (!currentGameId) {
      teamSelect.innerHTML = '<option value="">請先選擇比賽</option>';
      return;
    }
    const g = games[currentGameId];
    teamSelect.innerHTML = `
      <option value="${g.team1}">${g.team1}</option>
      <option value="${g.team2}">${g.team2}</option>
    `;
    team1Header.textContent = g.team1;
    team2Header.textContent = g.team2;
  }

  // 新增事件按鈕點擊
  document.getElementById('btnAddEvent').addEventListener('click', () => {
    if (!currentGameId) {
      alert('請先選擇比賽');
      return;
    }
    const g = games[currentGameId];
    const inning = currentInning;

    const pitchCount = Number(pitchCountInput.value);
    const team = teamSelect.value;
    const batter = batterInput.value.trim();
    const pitchResult = pitchResultSelect.value;
    const battingResult = battingResultSelect.value;
    const outReason = outReasonSelect.value;
    const stealStart = stealStartSelect.value;
    const stealEnd = stealEndSelect.value;
    const stealResult = stealResultSelect.value;
    const bases = [base1.checked, base2.checked, base3.checked];
    const rbi = Number(rbiInput.value);
    const runs = Number(runsInput.value);
    const remark = remarkInput.value.trim();

    if (!team) {
      alert('請選擇隊伍');
      return;
    }
    if (!batter) {
      alert('請輸入打者');
      return;
    }
    // 建立事件物件
    const event = {
      inning,
      pitchCount,
      team,
      batter,
      pitchResult,
      battingResult,
      outReason,
      stealStart,
      stealEnd,
      stealResult,
      bases,
      rbi,
      runs,
      remark,
      timestamp: Date.now()
    };

    // 新增到全場事件陣列
    g.events.push(event);

    // 新增局資料與分數更新
    if (!g.innings[inning]) {
      g.innings[inning] = { team1Runs: 0, team2Runs: 0 };
    }
    if (team === g.team1) {
      g.innings[inning].team1Runs += runs;
    } else if (team === g.team2) {
      g.innings[inning].team2Runs += runs;
    }

    saveGames();
    updateScoreTable();
    updateEventList();

    // 清除輸入欄位，但保留隊伍與局數
    pitchCountInput.value = 1;
    batterInput.value = '';
    pitchResultSelect.value = 'S';
    battingResultSelect.value = '';
    outReasonSelect.value = '';
    stealStartSelect.value = '';
    stealEndSelect.value = '';
    stealResultSelect.value = '';
    base1.checked = false;
    base2.checked = false;
    base3.checked = false;
    rbiInput.value = 0;
    runsInput.value = 0;
    remarkInput.value = '';
  });

  // 更新比分表
  function updateScoreTable() {
    if (!currentGameId) {
      scoreTableBody.innerHTML = '<tr><td colspan="3">請先選擇比賽</td></tr>';
      return;
    }
    const g = games[currentGameId];
    const inningsKeys = Object.keys(g.innings).sort((a,b) => a - b);

    if (inningsKeys.length === 0) {
      // 沒有局資料，顯示0分
      scoreTableBody.innerHTML = '';
      for (let i=1; i<=9; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i}</td><td>0</td><td>0</td>`;
        scoreTableBody.appendChild(tr);
      }
      return;
    }

    scoreTableBody.innerHTML = '';
    for(let i=1; i<=9; i++) {
      const inningStr = i.toString();
      const runs1 = g.innings[inningStr] ? g.innings[inningStr].team1Runs : 0;
      const runs2 = g.innings[inningStr] ? g.innings[inningStr].team2Runs : 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i}</td><td>${runs1}</td><td>${runs2}</td>`;
      scoreTableBody.appendChild(tr);
    }
  }

  // 更新事件列表（條列）
  function updateEventList() {
    if (!currentGameId) {
      eventList.innerHTML = '<li>請先選擇比賽</li>';
      return;
    }
    const g = games[currentGameId];
    if (g.events.length === 0) {
      eventList.innerHTML = '<li>尚無事件</li>';
      return;
    }

    // 過濾當前局事件
    const filteredEvents = g.events.filter(e => e.inning === currentInning);

    if (filteredEvents.length === 0) {
      eventList.innerHTML = '<li>本局尚無事件</li>';
      return;
    }

    eventList.innerHTML = '';
    filteredEvents.forEach((e, idx) => {
      const basesStr = [
        e.bases[0] ? '一壘有人' : '',
        e.bases[1] ? '二壘有人' : '',
        e.bases[2] ? '三壘有人' : ''
      ].filter(Boolean).join(', ') || '無壘包有人';

      const line = `${idx+1}. 局數:${e.inning} 球數:${e.pitchCount} 隊伍:${e.team} 打者:${e.batter}
  投球結果:${pitchResultNames[e.pitchResult]} 打擊結果:${battingResultNames[e.battingResult] || '無'} 出局原因:${outReasonNames[e.outReason] || '無'}
  盜壘:${e.stealStart ? e.stealStart + '→' + e.stealEnd + ' (' + (e.stealResult || '未知') + ')' : '無'}
  壘包狀況:${basesStr} 打點:${e.rbi} 得分:${e.runs}
  備註:${e.remark || '無'}`;

      const li = document.createElement('li');
      li.textContent = line;
      eventList.appendChild(li);
    });
  }

  // 初始載入
  updateGameOptions();

</script>

</body>
</html>
